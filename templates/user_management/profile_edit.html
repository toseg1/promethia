{% extends 'base.html' %}
{% load static %}
{% load profile_extras %}

{% block page_title %}Edit Profile{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
<li class="breadcrumb-item active">Profile</li>
{% endblock %}

{% block extra_css %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<!-- Profile-specific styles -->
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Profile Image Section -->
    <div class="col-md-4 col-lg-3">
      <div class="card card-primary card-outline">
        <div class="card-body box-profile">
          <div class="text-center">
            <div class="profile-image-container mb-3">
              {{ user|profile_image_or_initials_large|safe }}
            </div>
            
            <!-- File input (hidden) -->
            <input type="file" id="profile-image-input" accept="image/*" style="display: none;">
            
            <div class="btn-group-vertical w-100">
              <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('profile-image-input').click()">
                <i class="fas fa-camera"></i> Change
              </button>
              
              {% if user.profile.profile_picture %}
            <button type="button" class="btn btn-outline-danger btn-sm mt-1" data-toggle="modal" data-target="#confirmRemoveModal">

                  <i class="fas fa-trash"></i> Remove
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-8 col-lg-9">
      <div class="card card-primary card-outline">
        
        <form method="post" enctype="multipart/form-data" id="profile-form" novalidate>
          {% csrf_token %}
         <div class="card-body">
  
  <!-- General Information Section -->
  <div class="row">
    <div class="col-12">
      <h5 class="text-primary mb-3">
        <i class="fas fa-user mr-2"></i>General Information
      </h5>
    </div>
  </div>

  <div class="row">
    <!-- First Name -->
    <div class="col-md-6">
      <div class="form-group">
        <label for="{{ form.first_name.id_for_label }}">
          <i class="fas fa-user mr-1"></i>
          First Name <span class="text-danger">*</span>
        </label>
        <input type="text" name="first_name" value="{{ form.first_name.value|default:'' }}" class="form-control" id="{{ form.first_name.id_for_label }}" required>
        {% if form.first_name.errors %}
          <div class="text-danger">{{ form.first_name.errors.0 }}</div>
        {% endif %}
      </div>
    </div>
    
    <!-- Last Name -->
    <div class="col-md-6">
      <div class="form-group">
        <label for="{{ form.last_name.id_for_label }}">
          <i class="fas fa-user mr-1"></i>
          Last Name <span class="text-danger">*</span>
        </label>
        <input type="text" name="last_name" value="{{ form.last_name.value|default:'' }}" class="form-control" id="{{ form.last_name.id_for_label }}" required>
        {% if form.last_name.errors %}
          <div class="text-danger">{{ form.last_name.errors.0 }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Email (Read-only) -->
    <div class="col-md-6">
      <div class="form-group">
        <label>
          <i class="fas fa-envelope mr-1"></i>
          Email
        </label>
        <input type="email" value="{{ user.email }}" class="form-control" readonly>
        <small class="form-text text-muted">
          <i class="fas fa-lock mr-1"></i>Contact admin to change
        </small>
      </div>
    </div>
    
    <!-- Role -->
    <div class="col-md-6">
      <div class="form-group">
        <label for="id_role">
          <i class="fas fa-user-tag mr-1"></i>
          Role <span class="text-danger">*</span>
        </label>
        <select name="role" class="form-control" id="id_role" required>
          <option value="">Select Role</option>
          <option value="athlete" {% if user.profile.role == 'athlete' %}selected{% endif %}>Athlete</option>
          <option value="coach" {% if user.profile.role == 'coach' %}selected{% endif %}>Coach</option>
        </select>
        <small class="form-text text-muted">Sets your default view when logging in</small>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Phone Number -->
    <div class="col-md-6">
      <div class="form-group">
        <label for="{{ form.phone_number.id_for_label }}">
          <i class="fas fa-phone mr-1"></i>
          Phone Number
        </label>
        {{ form.phone_number }}
        {% if form.phone_number.errors %}
          <div class="text-danger">{{ form.phone_number.errors.0 }}</div>
        {% endif %}
      </div>
    </div>
    
    <!-- Date of Birth -->
    <div class="col-md-6">
      <div class="form-group">
        <label for="{{ form.date_of_birth.id_for_label }}">
          <i class="fas fa-birthday-cake mr-1"></i>
          Date of Birth
        </label>
        {{ form.date_of_birth }}
        {% if user.profile.age %}
          <small class="form-text text-muted">Current age: {{ user.profile.age }} years</small>
        {% endif %}
        {% if form.date_of_birth.errors %}
          <div class="text-danger">{{ form.date_of_birth.errors.0 }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Club -->
    <div class="col-md-6">
      <div class="form-group">
        <label for="{{ form.club.id_for_label }}">
          <i class="fas fa-users mr-1"></i>
          Club
        </label>
        {{ form.club }}
        {% if form.club.errors %}
          <div class="text-danger">{{ form.club.errors.0 }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Sport Metrics Section -->
  <div class="row mt-4">
    <div class="col-12">
      <h5 class="text-success mb-3">
        <i class="fas fa-chart-line mr-2"></i>Sport Metrics
        <i class="fas fa-info-circle ml-2 text-info" 
           data-toggle="tooltip" 
           data-placement="top" 
           title="Update dates are automatically recorded when you modify these values."
           style="cursor: help;"></i>
      </h5>
    </div>
  </div>

  <div class="row">
    <!-- VMA -->
    <div class="col-md-4">
      <div class="form-group">
        <label for="{{ form.vma.id_for_label }}">
          <i class="fas fa-tachometer-alt mr-1"></i>
          MAS (km/h)
        </label>
        {{ form.vma }}
        {% if user.profile.vma_updated %}
          <small class="form-text text-muted">Updated: {{ user.profile.vma_updated|date:"M d, Y" }}</small>
        {% endif %}
        {% if form.vma.errors %}
          <div class="text-danger">{{ form.vma.errors.0 }}</div>
        {% endif %}
      </div>
    </div>
    
    <!-- FTP -->
    <div class="col-md-4">
      <div class="form-group">
        <label for="{{ form.ftp.id_for_label }}">
          <i class="fas fa-bolt mr-1"></i>
          FTP (watts)
        </label>
        {{ form.ftp }}
        {% if user.profile.ftp_updated %}
          <small class="form-text text-muted">Updated: {{ user.profile.ftp_updated|date:"M d, Y" }}</small>
        {% endif %}
        {% if form.ftp.errors %}
          <div class="text-danger">{{ form.ftp.errors.0 }}</div>
        {% endif %}
      </div>
    </div>
    
    <!-- CSS -->
    <div class="col-md-4">
      <div class="form-group">
        <label for="{{ form.css.id_for_label }}">
          <i class="fas fa-swimmer mr-1"></i>
          CSS (per 100m)
        </label>
        {{ form.css }}
        {% if user.profile.css_updated %}
          <small class="form-text text-muted">Updated: {{ user.profile.css_updated|date:"M d, Y" }}</small>
        {% endif %}
        {% if form.css.errors %}
          <div class="text-danger">{{ form.css.errors.0 }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- About Me Section -->
  <div class="row mt-4">
    <div class="col-12">
      <h5 class="text-info mb-3">
        <i class="fas fa-quote-left mr-2"></i>About Me
      </h5>
    </div>
  </div>

  <div class="form-group">
    <label for="{{ form.bio.id_for_label }}">
      <i class="fas fa-edit mr-1"></i>
      Bio
    </label>
    {{ form.bio }}
    {% if form.bio.errors %}
      <div class="text-danger">{{ form.bio.errors.0 }}</div>
    {% endif %}
    <small class="form-text text-muted">Tell us about yourself, your goals, or anything you'd like to share.</small>
  </div>
</div>

        <div class="card-footer">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save mr-1"></i>
            Save Changes
          </button>
          <a href="{% url 'dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-times mr-1"></i>
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Image Cropper Modal -->
<div class="modal fade" id="cropperModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Crop Your Profile Picture</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="img-container">
          <img id="crop-image" style="max-width: 100%;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="crop-and-save">Crop & Save</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="confirmRemoveModal" tabindex="-1" role="dialog" aria-labelledby="confirmRemoveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmRemoveModalLabel">
          <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Removal
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to remove your profile picture?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <form method="post" action="{% url 'remove_profile_picture' %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Yes, Remove</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<!-- Profile-specific JavaScript -->
<script src="{% static 'js/profile.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const removeBtn = document.getElementById('remove-picture-btn');
    if (removeBtn) {
      removeBtn.addEventListener('click', function (e) {
        const confirmDelete = confirm("Are you sure you want to remove your profile picture?");
        if (!confirmDelete) {
          e.preventDefault();
        } else {
          // Optionally submit a hidden form or trigger an AJAX call here
          // For now, just proceed to let the default action happen
        }
      });
    }
  });
</script>
{% endblock %}