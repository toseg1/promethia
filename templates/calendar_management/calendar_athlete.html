{% extends 'base.html' %}
{% load static %}
{% load calendar_extras %}

{% block page_title %}
  {% if is_coach_view %}
    {{ viewing_athlete.get_full_name }}'s Calendar
  {% else %}
    My Calendar
  {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/calendar.css' %}">
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
{% if is_coach_view %}
  <li class="breadcrumb-item"><a href="{% url 'calendar_management:coach_view' %}">Coach Calendar</a></li>
  <li class="breadcrumb-item active">{{ viewing_athlete.get_full_name }}'s Calendar</li>
{% else %}
  <li class="breadcrumb-item active">Calendar</li>
{% endif %}
{% endblock %}

{% block content %}

<!-- Calendar Controls -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <!-- Desktop Layout: Title and buttons side by side -->
        <div class="row align-items-center d-none d-md-flex">
          <div class="col-md-6">
            <h4 class="mb-0">
              <i class="fas fa-calendar-alt mr-2 text-primary"></i>
              {% if is_coach_view %}
                {{ viewing_athlete.get_full_name }}'s Calendar
              {% else %}
                My Training Calendar
              {% endif %}
            </h4>
            {% if is_coach_view %}
              <small class="text-muted">
                <i class="fas fa-user-tie mr-1"></i>
                Viewing as coach
              </small>
            {% endif %}
          </div>
          <div class="col-md-6">
            <div class="float-right">
              {% if is_coach_view %}
                <!-- Coach viewing athlete - different navigation -->
                <!-- View Toggle for Coach -->
                <div class="btn-group mr-3" role="group">
                  <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=month&year={{ year }}&month={{ month }}" 
                     class="btn btn-outline-primary {% if view_type == 'month' %}active{% endif %}">
                    <i class="fas fa-calendar"></i> Month
                  </a>
                  <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=week&week_start={{ week_start_date|date:'Y-m-d' }}" 
                     class="btn btn-outline-primary {% if view_type == 'week' %}active{% endif %}">
                    <i class="fas fa-calendar-week"></i> Week
                  </a>
                </div>
                
                <!-- Add Event Button for Coach -->
                <div class="btn-group" role="group">
                  <a href="{% url 'session_create' %}?athlete={{ viewing_athlete.id }}" class="btn btn-success" >
                    <i class="fas fa-plus"></i> Add Training
                  </a>
                </div>
              {% else %}
                <!-- Original athlete view controls -->
                <!-- View Toggle -->
                <div class="btn-group mr-3" role="group">
                  <a href="{% url 'calendar_management:view' %}?view=month&year={{ year }}&month={{ month }}" 
                     class="btn btn-outline-primary {% if view_type == 'month' %}active{% endif %}">
                    <i class="fas fa-calendar"></i> Month
                  </a>
                  <a href="{% url 'calendar_management:view' %}?view=week&week_start={{ week_start_date|date:'Y-m-d' }}" 
                     class="btn btn-outline-primary {% if view_type == 'week' %}active{% endif %}">
                    <i class="fas fa-calendar-week"></i> Week
                  </a>
                </div>
                
                <!-- Add Event Button -->
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown">
                    <i class="fas fa-plus"></i> Add Event
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="{% url 'session_create' %}">
                      <i class="fas fa-running"></i> Training Session
                    </a>
                    <a class="dropdown-item" href="{% url 'race_events:race_create' %}">
                      <i class="fas fa-trophy"></i> Race
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{% url 'calendar_management:create_custom_event' %}">
                      <i class="fas fa-star"></i> Custom Event
                    </a>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Mobile Layout: Title on top, buttons below -->
        <div class="d-block d-md-none">
          <!-- Title Section -->
          <div class="mb-3">
            <h4 class="mb-1">
              <i class="fas fa-calendar-alt mr-2 text-primary"></i>
              {% if is_coach_view %}
                {{ viewing_athlete.get_full_name }}'s Calendar
              {% else %}
                My Training Calendar
              {% endif %}
            </h4>
            {% if is_coach_view %}
              <small class="text-muted">
                <i class="fas fa-user-tie mr-1"></i>
                Viewing as coach
              </small>
            {% endif %}
          </div>

          <!-- Buttons Section -->
          <div class="row">
            <div class="col-12">
              {% if is_coach_view %}
                <!-- Coach Mobile Controls -->
                <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                  <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=month&year={{ year }}&month={{ month }}" 
                     class="btn btn-outline-primary {% if view_type == 'month' %}active{% endif %}">
                    <i class="fas fa-calendar"></i> Month
                  </a>
                  <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=week&week_start={{ week_start_date|date:'Y-m-d' }}" 
                     class="btn btn-outline-primary {% if view_type == 'week' %}active{% endif %}">
                    <i class="fas fa-calendar-week"></i> Week
                  </a>
                </div>
                
                <div class="btn-group btn-group-sm w-100" role="group">
                  <a href="{% url 'session_create' %}?athlete={{ viewing_athlete.id }}" class="btn btn-success btn-block">
                    <i class="fas fa-plus"></i> Add Training
                  </a>
                </div>
              {% else %}
                <!-- Athlete Mobile Controls -->
                <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                  <a href="{% url 'calendar_management:view' %}?view=month&year={{ year }}&month={{ month }}" 
                     class="btn btn-outline-primary {% if view_type == 'month' %}active{% endif %}">
                    <i class="fas fa-calendar"></i> Month
                  </a>
                  <a href="{% url 'calendar_management:view' %}?view=week&week_start={{ week_start_date|date:'Y-m-d' }}" 
                     class="btn btn-outline-primary {% if view_type == 'week' %}active{% endif %}">
                    <i class="fas fa-calendar-week"></i> Week
                  </a>
                </div>
                
                <!-- Mobile Add Event Dropdown -->
                <div class="btn-group btn-group-sm w-100" role="group">
                  <button type="button" class="btn btn-success dropdown-toggle btn-block" data-toggle="dropdown">
                    <i class="fas fa-plus"></i> Add Event
                  </button>
                  <div class="dropdown-menu w-100">
                    <a class="dropdown-item" href="{% url 'session_create' %}">
                      <i class="fas fa-running"></i> Training Session
                    </a>
                    <a class="dropdown-item" href="{% url 'race_events:race_create' %}">
                      <i class="fas fa-trophy"></i> Race
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{% url 'calendar_management:create_custom_event' %}">
                      <i class="fas fa-star"></i> Custom Event
                    </a>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if view_type == 'month' %}
  <!-- Month View -->
  <div class="row">
    <div class="col-12">
      <div class="card card-primary">
        <div class="card-header" data-current-month="{{ month }}" data-current-year="{{ year }}">
          <div class="row align-items-center">
            <div class="col-md-6">
              <h3 class="card-title mb-0">
                <i class="fas fa-calendar mr-2"></i>
                {{ month|month_name }} {{ year }}
              </h3>
            </div>
            <div class="col-md-6">
              <div class="float-right">
                <!-- Month Navigation -->
                <div class="btn-group" role="group">
                  {% if month == 1 %}
                    {% if is_coach_view %}
                      <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=month&year={{ year|add:'-1' }}&month=12" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-left"></i>
                      </a>
                    {% else %}
                      <a href="{% url 'calendar_management:view' %}?view=month&year={{ year|add:'-1' }}&month=12" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-left"></i>
                      </a>
                    {% endif %}
                  {% else %}
                    {% if is_coach_view %}
                      <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=month&year={{ year }}&month={{ month|add:'-1' }}" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-left"></i>
                      </a>
                    {% else %}
                      <a href="{% url 'calendar_management:view' %}?view=month&year={{ year }}&month={{ month|add:'-1' }}" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-left"></i>
                      </a>
                    {% endif %}
                  {% endif %}
                  
                  {% if is_coach_view %}
                    <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=month" 
                       class="btn btn-link btn-sm text-white">
                      Today
                    </a>
                  {% else %}
                    <a href="{% url 'calendar_management:view' %}?view=month" 
                       class="btn btn-link btn-sm text-white">
                      Today
                    </a>
                  {% endif %}
                  
                  {% if month == 12 %}
                    {% if is_coach_view %}
                      <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=month&year={{ year|add:'1' }}&month=1" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-right"></i>
                      </a>
                    {% else %}
                      <a href="{% url 'calendar_management:view' %}?view=month&year={{ year|add:'1' }}&month=1" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-right"></i>
                      </a>
                    {% endif %}
                  {% else %}
                    {% if is_coach_view %}
                      <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=month&year={{ year }}&month={{ month|add:'1' }}" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-right"></i>
                      </a>
                    {% else %}
                      <a href="{% url 'calendar_management:view' %}?view=month&year={{ year }}&month={{ month|add:'1' }}" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-right"></i>
                      </a>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="calendar-month">
            <!-- Calendar Header -->
            <div class="calendar-header">
              <div class="calendar-day-header">Mon</div>
              <div class="calendar-day-header">Tue</div>
              <div class="calendar-day-header">Wed</div>
              <div class="calendar-day-header">Thu</div>
              <div class="calendar-day-header">Fri</div>
              <div class="calendar-day-header">Sat</div>
              <div class="calendar-day-header">Sun</div>
            </div>
            
            <!-- Calendar Body -->
            <div class="calendar-body">
              {% if calendar_data %}
                {% for week in calendar_data %}
                  <div class="calendar-week">
                    {% for day_data in week %}
                      <div class="calendar-day 
                          {% if not day_data.day %}calendar-day-empty{% endif %} 
                          {% if day_data.day == today.day and month == today.month and year == today.year %}calendar-day-today{% endif %}"
                          {% if day_data.day %}
                            data-date="{{ year }}-{{ month|stringformat:'02d' }}-{{ day_data.day|stringformat:'02d' }}"
                            tabindex="0"
                          {% endif %}>
                        {% if day_data.day %}
                          <div class="day-number">{{ day_data.day }}</div>
                          <div class="day-events">
                            {% for event in day_data.events %}
                              <!-- FIXED: Corrected conditional logic -->
                              {% if is_coach_view %}
                                {% include 'calendar_management/partials/event_card.html' with event=event %}
                              {% else %}
                                {% include 'calendar_management/partials/event_card.html' with event=event %}
                              {% endif %}
                            {% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endfor %}
              {% else %}
                <!-- Fallback basic calendar if calendar_data is not available -->
                {% for week_num in "1234567"|make_list %}
                  <div class="calendar-week">
                    {% for day_num in "1234567"|make_list %}
                      <div class="calendar-day" 
                           data-date="{{ year }}-{{ month|stringformat:'02d' }}-{{ forloop.counter|stringformat:'02d' }}"
                           tabindex="0">
                        <div class="day-number">{{ forloop.counter }}</div>
                        <div class="day-events">
                          <!-- Events will be populated here -->
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% else %}
  <!-- Week View - Desktop and Mobile Responsive -->
  <div class="row">
    <div class="col-12">
      <div class="card card-primary">
        <div class="card-header">
          <div class="row align-items-center">
            <div class="col-md-6">
              <h3 class="card-title mb-0">
                <i class="fas fa-calendar-week mr-2"></i>
                Week of {{ week_start_date|date:"F d, Y" }}
              </h3>
            </div>
            <div class="col-md-6">
              <div class="float-right">
                <!-- Week Navigation -->
                <div class="btn-group" role="group">
                  {% with prev_week=week_start_date|add_days:-7 %}
                    {% if is_coach_view %}
                      <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=week&week_start={{ prev_week|date:'Y-m-d' }}" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-left"></i>
                      </a>
                    {% else %}
                      <a href="{% url 'calendar_management:view' %}?view=week&week_start={{ prev_week|date:'Y-m-d' }}" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-left"></i>
                      </a>
                    {% endif %}
                  {% endwith %}
                  
                  {% if is_coach_view %}
                    <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=week" 
                       class="btn btn-link btn-sm text-white">
                      This Week
                    </a>
                  {% else %}
                    <a href="{% url 'calendar_management:view' %}?view=week" 
                       class="btn btn-link btn-sm text-white">
                      This Week
                    </a>
                  {% endif %}
                  
                  {% with next_week=week_start_date|add_days:7 %}
                    {% if is_coach_view %}
                      <a href="{% url 'calendar_management:coach_athlete_view' viewing_athlete.id %}?view=week&week_start={{ next_week|date:'Y-m-d' }}" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-right"></i>
                      </a>
                    {% else %}
                      <a href="{% url 'calendar_management:view' %}?view=week&week_start={{ next_week|date:'Y-m-d' }}" 
                         class="btn btn-link btn-sm text-white">
                        <i class="fas fa-chevron-right"></i>
                      </a>
                    {% endif %}
                  {% endwith %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          
          <!-- Desktop Week View (Hidden on Mobile) -->
          <div class="calendar-week-view d-none d-md-block">
            <!-- Week Days Header -->
            <div class="calendar-header">
              {% if week_days %}
                {% for day in week_days %}
                  <div class="calendar-day-header">
                    {{ day.day_short }}
                  </div>
                {% endfor %}
              {% else %}
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
                <div class="calendar-day-header">Sun</div>
              {% endif %}
            </div>
            
            <!-- Week Days Body -->
            <div class="calendar-body">
              <div class="calendar-week">
                {% if week_days %}
                  {% for day in week_days %}
                    <div class="calendar-day week-day
                        {% if day.date == today %}calendar-day-today{% endif %}"
                        data-date="{{ day.date|date:'Y-m-d' }}"
                        data-day-name="{{ day.date|date:'l, F j' }}"
                        tabindex="0">
                      <div class="day-number {% if day.date == today %}today{% endif %}">{{ day.day_num }}</div>
                      <div class="day-events">
                        {% for event in week_events %}
                          {% if event.date == day.date %}
                            {% if is_coach_view %}
                              {% include 'calendar_management/partials/event_card.html' with event=event %}
                            {% else %}
                              {% include 'calendar_management/partials/event_card.html' with event=event %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <!-- Fallback for 7 days if week_days is not available -->
                  {% for day_num in "1234567"|make_list %}
                    <div class="calendar-day week-day" 
                         data-date="{% now 'Y-m-d' %}"
                         tabindex="0">
                      <div class="day-number">{{ forloop.counter }}</div>
                      <div class="day-events">
                        <!-- Events will be populated here -->
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
  <!-- Mobile Week View (Vertical List) -->
          <div class="calendar-week-mobile d-block d-md-none">
            {% if week_days %}
              {% for day in week_days %}
                <div class="calendar-day mobile-vertical-day 
                           {% if day.date == today %}calendar-day-today{% endif %}" 
                     data-date="{{ day.date|date:'Y-m-d' }}"
                     tabindex="0">
                  
                  <!-- Day Header with day number on left and day name on right -->
                  <div class="mobile-day-header">
                    <div class="day-number {% if day.date == today %}today{% endif %}">{{ day.day_num }}</div>
                    <div class="mobile-day-label">
                      {{ day.date|date:"l, F j" }}
                    </div>
                  </div>
                  
                  <!-- Day Events -->
                  <div class="day-events">
                    {% for event in week_events %}
                      {% if event.date == day.date %}
                        {% if is_coach_view %}
                          {% include 'calendar_management/partials/event_card.html' with event=event %}
                        {% else %}
                          {% include 'calendar_management/partials/event_card.html' with event=event %}
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <!-- Fallback mobile view -->
              <div class="text-center p-4">
                <p class="text-muted">No week data available</p>
              </div>
            {% endif %}
          </div>
      </div>
    </div>
  </div>
{% endif %}

<!-- Custom Event Modal -->
<div class="modal fade" id="customEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {% if is_coach_view %}
            Event Details for {{ viewing_athlete.get_full_name }}
          {% else %}
            Custom Event Details
          {% endif %}
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="customEventDetails">
          <!-- Content will be loaded via JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <div class="btn-group" id="customEventActions" style="display: none;">
          <a href="#" class="btn btn-warning btn-sm" id="editCustomEventBtn">
            <i class="fas fa-edit"></i> Edit
          </a>
          {% if not is_coach_view %}
            <a href="#" class="btn btn-danger btn-sm" id="deleteCustomEventBtn" 
               onclick="return confirm('Delete this event?')">
              <i class="fas fa-trash"></i> Delete
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Coach View Info Panel -->
{% if is_coach_view %}
<div class="row mt-3">
  <div class="col-12">
    <div class="alert alert-info">
      <div class="row align-items-center">
        <div class="col-md-8">
          <i class="fas fa-info-circle mr-2"></i>
          <strong>Coach View:</strong> You are viewing {{ viewing_athlete.get_full_name }}'s complete calendar.
          This includes all training sessions, races, and custom events.
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Training Volume Section -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="row align-items-center mb-3">
          <div class="col-md-8">
            <h4 class="mb-0">
              <i class="fas fa-chart-bar mr-2 text-primary"></i>
              Completed Training Volume
              {% if view_type == 'month' %}
                - {{ month|month_name }} {{ year }}
              {% else %}
                - Week of {{ week_start_date|date:"M d, Y" }}
              {% endif %}
            </h4>
          </div>
          <div class="col-md-4">
            <div class="float-right">
              <small class="text-muted">
                {% if view_type == 'month' %}
                  <i class="fas fa-calendar mr-1"></i>Monthly Completed Sessions
                {% else %}
                  <i class="fas fa-calendar-week mr-1"></i>Weekly Completed Sessions
                {% endif %}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% if volume_data %}
<!-- Volume Widgets Row -->
<div class="row">
  <!-- Total Volume -->
  <div class="col-lg-3 col-md-6 col-12 mb-3">
    <div class="small-box bg-primary">
      <div class="inner">
        <h3>{{ volume_data.total.sessions }}</h3>
        <p>Completed Session(s)</p>
      </div>
      <div class="icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="small-box-footer">
        <span class="text-white">{{ volume_data.total.duration_formatted }}</span>
      </div>
    </div>
  </div>

  <!-- Running Volume (including trail) -->
  <div class="col-lg-3 col-md-6 col-12 mb-3">
    <div class="small-box bg-success">
      <div class="inner">
        <h3>{{ volume_data.running.sessions }}</h3>
        <p>Running Completed</p>
      </div>
      <div class="icon">
        <i class="fas fa-running"></i>
      </div>
      <div class="small-box-footer">
        <span class="text-white">{{ volume_data.running.duration_formatted }}</span>
      </div>
    </div>
  </div>

  <!-- Cycling Volume -->
  <div class="col-lg-3 col-md-6 col-12 mb-3">
    <div class="small-box bg-info">
      <div class="inner">
        <h3>{{ volume_data.cycling.sessions }}</h3>
        <p>Cycling Completed</p>
      </div>
      <div class="icon">
        <i class="fas fa-bicycle"></i>
      </div>
      <div class="small-box-footer">
        <span class="text-white">{{ volume_data.cycling.duration_formatted }}</span>
      </div>
    </div>
  </div>

  <!-- Swimming Volume -->
  <div class="col-lg-3 col-md-6 col-12 mb-3">
    <div class="small-box bg-warning">
      <div class="inner">
        <h3>{{ volume_data.swimming.sessions }}</h3>
        <p>Swimming Completed</p>
      </div>
      <div class="icon">
        <i class="fas fa-swimmer"></i>
      </div>
      <div class="small-box-footer">
        <span class="text-white">{{ volume_data.swimming.duration_formatted }}</span>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Visual Chart and Breakdown -->
{% if volume_data.total.sessions > 0 %}
<div class="row">
  <!-- Chart Section -->
  <div class="col-lg-8">
    <div class="card card-primary card-outline">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-chart-column mr-2"></i>
          Completed Training Distribution
        </h3>
        <div class="card-tools">
          <button type="button" class="btn btn-tool" data-card-widget="collapse">
            <i class="fas fa-minus"></i>
          </button>
        </div>
      </div>
      <div class="card-body">
        <!-- Chart Container -->
        <div style="position: relative; height: 300px;">
          <canvas id="trainingVolumeChart"></canvas>
        </div>
        
        <!-- Fallback: Simple bars if chart fails -->
        <div id="chartFallback" style="display: none;">
          <h5 class="text-center mb-3">Training Volume Overview</h5>
          
          {% if volume_data.running.sessions > 0 %}
          <div class="row mb-2">
            <div class="col-3"><strong>Running:</strong></div>
            <div class="col-6">
              <div class="progress">
                <div class="progress-bar bg-success" style="width: {% widthratio volume_data.running.sessions volume_data.total.sessions 100 %}%"></div>
              </div>
            </div>
            <div class="col-3">{{ volume_data.running.sessions }} sessions ({{ volume_data.running.duration_formatted }})</div>
          </div>
          {% endif %}
          
          {% if volume_data.cycling.sessions > 0 %}
          <div class="row mb-2">
            <div class="col-3"><strong>Cycling:</strong></div>
            <div class="col-6">
              <div class="progress">
                <div class="progress-bar bg-info" style="width: {% widthratio volume_data.cycling.sessions volume_data.total.sessions 100 %}%"></div>
              </div>
            </div>
            <div class="col-3">{{ volume_data.cycling.sessions }} sessions ({{ volume_data.cycling.duration_formatted }})</div>
          </div>
          {% endif %}
          
          {% if volume_data.swimming.sessions > 0 %}
          <div class="row mb-2">
            <div class="col-3"><strong>Swimming:</strong></div>
            <div class="col-6">
              <div class="progress">
                <div class="progress-bar bg-warning" style="width: {% widthratio volume_data.swimming.sessions volume_data.total.sessions 100 %}%"></div>
              </div>
            </div>
            <div class="col-3">{{ volume_data.swimming.sessions }} sessions ({{ volume_data.swimming.duration_formatted }})</div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Bars Section -->
  <div class="col-lg-4">

    <div class="card card-success card-outline">
      
      <div class="card-header">
        <h3 class="card-title">
          
          <i class="fas fa-percentage mr-2"></i>
          Volume Breakdown
        </h3>
           <div class="card-tools">
          <button type="button" class="btn btn-tool" data-card-widget="collapse">
            <i class="fas fa-minus"></i>
          </button>
</div>
      </div>
      <div class="card-body">
        
        {% if volume_data.running.sessions > 0 %}
        <div class="progress-group">
          <span class="progress-text">
            <i class="fas fa-running text-success mr-1"></i>
            Running
          </span>
          <span class="float-right">
            <b>{{ volume_data.running.sessions }}</b>/{{ volume_data.total.sessions }}
          </span>
          <div class="progress progress-sm">
            <div class="progress-bar bg-success" 
                 style="width: {% if volume_data.total.sessions > 0 %}{% widthratio volume_data.running.sessions volume_data.total.sessions 100 %}{% else %}0{% endif %}%"></div>
          </div>
        </div>
        {% endif %}

        {% if volume_data.cycling.sessions > 0 %}
        <div class="progress-group">
          <span class="progress-text">
            <i class="fas fa-bicycle text-info mr-1"></i>
            Cycling
          </span>
          <span class="float-right">
            <b>{{ volume_data.cycling.sessions }}</b>/{{ volume_data.total.sessions }}
          </span>
          <div class="progress progress-sm">
            <div class="progress-bar bg-info" 
                 style="width: {% if volume_data.total.sessions > 0 %}{% widthratio volume_data.cycling.sessions volume_data.total.sessions 100 %}{% else %}0{% endif %}%"></div>
          </div>
        </div>
        {% endif %}

        {% if volume_data.swimming.sessions > 0 %}
        <div class="progress-group">
          <span class="progress-text">
            <i class="fas fa-swimmer text-warning mr-1"></i>
            Swimming
          </span>
          <span class="float-right">
            <b>{{ volume_data.swimming.sessions }}</b>/{{ volume_data.total.sessions }}
          </span>
          <div class="progress progress-sm">
            <div class="progress-bar bg-warning" 
                 style="width: {% if volume_data.total.sessions > 0 %}{% widthratio volume_data.swimming.sessions volume_data.total.sessions 100 %}{% else %}0{% endif %}%"></div>
          </div>
        </div>
        {% endif %}

        <!-- Duration Breakdown -->
        <hr>
        <h6 class="text-center">Duration Breakdown</h6>
        
        {% if volume_data.running.duration > 0 %}
        <div class="progress-group">
          <span class="progress-text">Running Duration</span>
          <span class="float-right">
            <b>{{ volume_data.running.duration_formatted }}</b>
          </span>
          <div class="progress progress-sm">
            <div class="progress-bar bg-success" 
                 style="width: {% if volume_data.total.duration > 0 %}{% widthratio volume_data.running.duration volume_data.total.duration 100 %}{% else %}0{% endif %}%"></div>
          </div>
        </div>
        {% endif %}

        {% if volume_data.cycling.duration > 0 %}
        <div class="progress-group">
          <span class="progress-text">Cycling Duration</span>
          <span class="float-right">
            <b>{{ volume_data.cycling.duration_formatted }}</b>
          </span>
          <div class="progress progress-sm">
            <div class="progress-bar bg-info" 
                 style="width: {% if volume_data.total.duration > 0 %}{% widthratio volume_data.cycling.duration volume_data.total.duration 100 %}{% else %}0{% endif %}%"></div>
          </div>
        </div>
        {% endif %}

        {% if volume_data.swimming.duration > 0 %}
        <div class="progress-group">
          <span class="progress-text">Swimming Duration</span>
          <span class="float-right">
            <b>{{ volume_data.swimming.duration_formatted }}</b>
          </span>
          <div class="progress progress-sm">
            <div class="progress-bar bg-warning" 
                 style="width: {% if volume_data.total.duration > 0 %}{% widthratio volume_data.swimming.duration volume_data.total.duration 100 %}{% else %}0{% endif %}%"></div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

{% else %}
<!-- No Data State -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body text-center">
        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
        <h4>No completed training sessions</h4>
        <p class="text-muted">
          {% if view_type == 'month' %}
            No training sessions completed this month yet
          {% else %}
            No training sessions completed this week yet
          {% endif %}
        </p>
        <p class="text-muted">
          <small>Complete your training sessions to see volume analytics here</small>
        </p>
        <a href="{% url 'session_create' %}" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add Training Session
        </a>
      </div>
    </div>
  </div>
</div>
{% endif %}


<!-- Custom Event Modal -->
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/calendar.js' %}"></script>
<script>
    // FIXED: Proper URL construction without undefined values
    const urls = {
        sessionCreate: "{% url 'session_create' %}",
        raceCreate: "{% url 'race_events:race_create' %}",
        customEventCreate: "{% url 'calendar_management:create_custom_event' %}"
    };

    // FIXED: Use current_view instead of is_coach_view
    let currentUserView = '{{ current_view|default:"athlete" }}';
    let userRole = '{{ user.profile.role|default:"athlete" }}';
    let viewingAthleteId = null;

    // SAFE: Only set athlete ID if we actually have one
    {% if is_coach_view and viewing_athlete.id %}
        viewingAthleteId = {{ viewing_athlete.id }};
    {% endif %}

    // Debug the values to make sure they're correct
    console.log('ðŸ” Calendar Template Debug:');
    console.log('   currentUserView:', currentUserView);
    console.log('   userRole:', userRole);
    console.log('   viewingAthleteId:', viewingAthleteId);
    console.log('   is_coach_view: {{ is_coach_view|yesno:"true,false" }}');

    // Validate viewingAthleteId is actually a number
    if (viewingAthleteId !== null && (typeof viewingAthleteId !== 'number' || isNaN(viewingAthleteId))) {
        console.warn('âš ï¸ Invalid viewingAthleteId, setting to null:', viewingAthleteId);
        viewingAthleteId = null;
    }

    // FIXED: Pass Django context data to JavaScript properly
    {% if volume_data %}
    window.trainingChartData = {
        total: {
            sessions: {{ volume_data.total.sessions }},
            duration: {{ volume_data.total.duration }},
            duration_formatted: "{{ volume_data.total.duration_formatted }}"
        },
        running: {
            sessions: {{ volume_data.running.sessions }},
            duration: {{ volume_data.running.duration }},
            duration_formatted: "{{ volume_data.running.duration_formatted }}"
        },
        cycling: {
            sessions: {{ volume_data.cycling.sessions }},
            duration: {{ volume_data.cycling.duration }},
            duration_formatted: "{{ volume_data.cycling.duration_formatted }}"
        },
        swimming: {
            sessions: {{ volume_data.swimming.sessions }},
            duration: {{ volume_data.swimming.duration }},
            duration_formatted: "{{ volume_data.swimming.duration_formatted }}"
        },
        viewType: "{{ view_type|default:'month' }}"
    };
    console.log('ðŸ“Š Training chart data loaded:', window.trainingChartData);
    console.log('ðŸ“Š Current view type:', "{{ view_type|default:'month' }}");
    {% else %}
    window.trainingChartData = null;
    console.log('ðŸ“Š No volume data available');
    {% endif %}

    // Training Volume Chart Implementation
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing training chart...');
        
        // Check if we have chart data
        if (!window.trainingChartData || window.trainingChartData.total.sessions === 0) {
            console.log('No training chart data or no completed sessions');
            showChartFallback();
            return;
        }
        
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded! Make sure you include Chart.js CDN.');
            showChartFallback();
            return;
        }
        
        const chartCanvas = document.getElementById('trainingVolumeChart');
        if (!chartCanvas) {
            console.error('Chart canvas not found!');
            return;
        }
        
        try {
            createTrainingChart();
        } catch (error) {
            console.error('Error creating chart:', error);
            showChartFallback();
        }
    });

    function createTrainingChart() {
        const data = window.trainingChartData;
        console.log('Creating pie chart with data:', data);
        
        // Prepare data arrays
        const sports = [];
        const sessionCounts = [];
        const colors = [];
        const hoverColors = [];
        
        // Add sports that have sessions
        if (data.running.sessions > 0) {
            sports.push('Running');
            sessionCounts.push(data.running.sessions);
            colors.push('#28a745');
            hoverColors.push('#1e7e34');
        }
        
        if (data.cycling.sessions > 0) {
            sports.push('Cycling');
            sessionCounts.push(data.cycling.sessions);
            colors.push('#17a2b8');
            hoverColors.push('#117a8b');
        }
        
        if (data.swimming.sessions > 0) {
            sports.push('Swimming');
            sessionCounts.push(data.swimming.sessions);
            colors.push('#ffc107');
            hoverColors.push('#d39e00');
        }
        
        console.log('Pie chart arrays:', { sports, sessionCounts, colors });
        
        // If no active sports, show fallback
        if (sports.length === 0) {
            console.log('No active sports found, showing fallback');
            showChartFallback();
            return;
        }
        
        const ctx = document.getElementById('trainingVolumeChart').getContext('2d');
        
        const chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: sports,
                datasets: [{
                    data: sessionCounts,
                    backgroundColor: colors,
                    hoverBackgroundColor: hoverColors,
                    borderWidth: 3,
                    borderColor: '#ffffff',
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: (function() {
                            const viewType = data.viewType || 'month';
                            console.log('Chart title - viewType:', viewType);
                            if (viewType === 'month') {
                                return 'Monthly Training Distribution';
                            } else if (viewType === 'week') {
                                return 'Weekly Training Distribution';
                            } else {
                                return 'Training Distribution';
                            }
                        })(),
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: 20,
                        color: '#2c3e50'
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                const chartData = chart.data;
                                if (chartData.labels.length && chartData.datasets.length) {
                                    return chartData.labels.map((label, i) => {
                                        const value = chartData.datasets[0].data[i];
                                        const total = chartData.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        
                                        return {
                                            text: `${label}: ${value} sessions (${percentage}%)`,
                                            fillStyle: chartData.datasets[0].backgroundColor[i],
                                            strokeStyle: '#ffffff',
                                            lineWidth: 2,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: '#ffffff',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                
                                // Get duration info
                                let durationText = '';
                                if (label === 'Running') {
                                    durationText = ` (${data.running.duration_formatted})`;
                                } else if (label === 'Cycling') {
                                    durationText = ` (${data.cycling.duration_formatted})`;
                                } else if (label === 'Swimming') {
                                    durationText = ` (${data.swimming.duration_formatted})`;
                                }
                                
                                return `${label}: ${value} sessions (${percentage}%)${durationText}`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });
        
        console.log('Pie chart created successfully!');
        
        // Hide fallback since chart worked
        const fallback = document.getElementById('chartFallback');
        if (fallback) {
            fallback.style.display = 'none';
        }
    }

    function showChartFallback() {
        console.log('Showing chart fallback');
        
        const canvas = document.getElementById('trainingVolumeChart');
        const fallback = document.getElementById('chartFallback');
        
        if (canvas) {
            canvas.style.display = 'none';
        }
        
        if (fallback) {
            fallback.style.display = 'block';
        }
    }

    // Also make chart creation available globally for debugging
    window.createTrainingChart = createTrainingChart;
    window.showChartFallback = showChartFallback;

</script>
{% endblock %}
